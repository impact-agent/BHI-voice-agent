<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Talk to our AI Agent</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; text-align:center; margin:40px; }
    h1 { display:inline-block; background:#2f64e1; color:#fff; padding:10px 16px; border-radius:8px; }
    p.note { background:#2f64e1; color:#fff; padding:8px 12px; border-radius:6px; display:inline-block; }
    button { padding:12px 18px; border-radius:12px; font-size:16px; cursor:pointer; margin:16px auto; border:none; color:#fff; }
    #callBtn { background:#22c55e; }
    #hangBtn { background:#ef4444; display:none; }
    #status { margin-top:10px; }
    #log { text-align:left; max-width:860px; margin:16px auto; background:#0b1220; color:#e5e7eb; padding:12px; border-radius:8px; overflow:auto; display:none; }
  </style>

  <!-- Primary SDK (jsDelivr); we add it dynamically so we can fall back if it fails -->
  <script>
    // Load a script with fallback
    function loadScript(src){ 
      return new Promise((resolve,reject)=>{ 
        const s=document.createElement('script'); 
        s.src=src; s.onload=resolve; s.onerror=reject; 
        document.head.appendChild(s);
      });
    }
    // Try primary, then fallback CDN
    window.__loadRetell = async () => {
      try { 
        await loadScript("https://cdn.jsdelivr.net/npm/retell-client-js-sdk@2.0.7/dist/index.min.js");
      } catch(_) { 
        await loadScript("https://unpkg.com/retell-client-js-sdk@2.0.7/dist/index.min.js");
      }
      return true;
    };
  </script>
</head>
<body>
  <h1>üé§ Talk to our AI Agent</h1>
  <p class="note">Uses your internet (no phone charges). Click ‚ÄúStart Call‚Äù and allow microphone access.</p>

  <div>
    <button id="callBtn">Start Call</button>
    <button id="hangBtn">Hang Up</button>
  </div>

  <div id="status">Loading agent‚Ä¶</div>
  <pre id="log"></pre>

  <script>
    // üëâ Your token-mint endpoint (Cloudflare Worker)
    const MINT_URL = "https://frosty-poetry-a7a6.jocelyn-379.workers.dev/";

    // Debug helpers
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    function setStatus(t){ statusEl.textContent = t; }
    function log(msg, obj){
      logEl.style.display='block';
      logEl.textContent += `[${new Date().toISOString()}] ${msg}\n` + (obj ? JSON.stringify(obj, null, 2) + '\n' : '');
      console.log(msg, obj||'');
    }

    let client = null;
    let inCall = false;
    const callBtn = document.getElementById('callBtn');
    const hangBtn = document.getElementById('hangBtn');

    // Wait for SDK to be available and construct the client
    async function ensureClient() {
      if (client) return true;
      // Load SDK (with fallback) if not already present
      await (window.__loadRetell?.());
      const g = window;
      const Ctor = g.retellClientJsSdk && g.retellClientJsSdk.RetellWebClient;
      if (!Ctor) {
        log("SDK not found on window.retellClientJsSdk. If you use an ad/privacy blocker, try Incognito.");
        return false;
      }
      try {
        client = new Ctor();
        client.on?.("call_ended", endCall);
        client.on?.("error", (e)=>{ console.error("Retell error", e); endCall(); setStatus("Error during call."); });
        return true;
      } catch(e) {
        log("Failed to construct client", { message: e.message });
        return false;
      }
    }

    async function mintToken(){
      // Preflight-free POST to avoid CORS issues
      const r = await fetch(MINT_URL, { method:'POST' });
      const text = await r.text();
      try { return JSON.parse(text); }
      catch(e){ log("Mint endpoint did not return JSON", text); throw new Error("Could not get a token. Try again."); }
    }

    async function startCall(){
      try{
        callBtn.disabled = true;
        setStatus("Preparing agent‚Ä¶");
        const ok = await ensureClient();
        if (!ok) { setStatus("Agent not ready. Refresh and try again."); return; }

        setStatus("Connecting‚Ä¶ please allow microphone");
        log("POST to mint URL", { url: MINT_URL });
        const { access_token, call_id } = await mintToken();
        log("Got token", { call_id, access_token_preview: (access_token||'').slice(0, 12) + "‚Ä¶" });
        if (!access_token) throw new Error("No access_token returned");

        await client.startCall({ accessToken: access_token });
        inCall = true;
        callBtn.style.display='none'; hangBtn.style.display='inline-block';
        setStatus("Connected. You can speak now.");
      } catch(e){
        setStatus(e.message || "Error starting call. See log.");
        log("startCall error", { message: e.message });
      } finally {
        callBtn.disabled = false;
      }
    }

    function endCall(){
      try{ client?.stopCall?.(); }catch(_){}
      inCall=false;
      hangBtn.style.display='none'; callBtn.style.display='inline-block';
      setStatus("Call ended.");
    }

    callBtn.addEventListener('click', ()=>{ if(!inCall) startCall(); });
    hangBtn.addEventListener('click', endCall);

    // Kick off SDK load and update status once ready
    (async () => {
      const ok = await ensureClient();
      setStatus(ok ? "Ready." : "Agent not ready‚Äîrefresh or try Incognito.");
    })();
  </script>
</body>
</html>
