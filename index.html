<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Talk to our AI Agent</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Stable Retell SDK build -->
  <script src="https://cdn.jsdelivr.net/npm/retell-client-js-sdk@2.0.7/dist/index.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; text-align:center; margin:40px; }
    h1 { display:inline-block; background:#2f64e1; color:#fff; padding:10px 16px; border-radius:8px; }
    p.note { background:#2f64e1; color:#fff; padding:8px 12px; border-radius:6px; display:inline-block; }
    button { padding:12px 18px; border-radius:12px; font-size:16px; cursor:pointer; margin:16px auto; border:none; color:#fff; }
    #callBtn { background:#22c55e; }
    #hangBtn { background:#ef4444; display:none; }
    #status { margin-top:10px; }
    #log { text-align:left; max-width:860px; margin:16px auto; background:#0b1220; color:#e5e7eb;
           padding:12px; border-radius:8px; overflow:auto; display:none; }
  </style>
</head>
<body>
  <h1>üé§ Talk to our AI Agent</h1>
  <p class="note">Uses your internet (no phone charges). Click ‚ÄúStart Call‚Äù and allow microphone access.</p>

  <div>
    <button id="callBtn">Start Call</button>
    <button id="hangBtn">Hang Up</button>
  </div>

  <div id="status">Ready.</div>
  <pre id="log"></pre>

  <script>
    // üëâ Your Zapier Catch Hook URL
    const MINT_URL = "https://bhi-voice-agent.jocelyn-379.workers.dev/";

    // Helpers
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    function setStatus(t){ statusEl.textContent = t; }
    function log(msg, obj){
      logEl.style.display='block';
      logEl.textContent += `[${new Date().toISOString()}] ${msg}\n` + (obj ? JSON.stringify(obj, null, 2) + '\n' : '');
      console.log(msg, obj||'');
    }

    // Get Retell client safely from the SDK namespace
    function getClient(){
      const g = window;
      if (g.retellClientJsSdk && g.retellClientJsSdk.RetellWebClient) {
        try { return new g.retellClientJsSdk.RetellWebClient(); } catch(e){ console.error(e); }
      }
      return null;
    }
    let client = getClient();

    // Minimal POST (no headers/body) so browsers don‚Äôt preflight the request
    async function mintToken(){
      const r = await fetch(MINT_URL, { method:'POST' });
      const text = await r.text();
      try { return JSON.parse(text); }
      catch(e){ log("Zap did not return JSON. Raw:", text); throw new Error("Could not get a token (Zap Step 3 must reply)."); }
    }

    const callBtn = document.getElementById('callBtn');
    const hangBtn = document.getElementById('hangBtn');
    let inCall = false;

    async function startCall(){
      try{
        if(!client){ setStatus("Agent not ready‚Äîrefresh the page."); log("SDK client missing"); return; }
        callBtn.disabled = true;
        setStatus("Connecting‚Ä¶ please allow microphone");
        log("POST to Zap", { url: MINT_URL });
        const { access_token, call_id } = await mintToken();
        log("Got token", { call_id, access_token_preview: (access_token||'').slice(0,12) + "‚Ä¶" });
        if(!access_token) throw new Error("No access_token from Zap");
        await client.startCall({ accessToken: access_token });
        inCall = true;
        callBtn.style.display='none'; hangBtn.style.display='inline-block';
        setStatus("Connected. You can speak now.");
      }catch(e){
        console.error(e); setStatus(e.message || "Error starting call. See log."); 
      }finally{
        callBtn.disabled = false;
      }
    }

    function endCall(){
      try{ client && client.stopCall && client.stopCall(); }catch(_){}
      inCall = false;
      hangBtn.style.display='none'; callBtn.style.display='inline-block';
      setStatus("Call ended.");
    }

    callBtn.addEventListener('click', ()=>{ if(!inCall) startCall(); });
    hangBtn.addEventListener('click', endCall);
    client && client.on && client.on("call_ended", endCall);
    client && client.on && client.on("error", (e)=>{ console.error("Retell error", e); endCall(); setStatus("Error during call."); });
  </script>
</body>
</html>
