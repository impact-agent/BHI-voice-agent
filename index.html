<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Talk to our AI Agent</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --blue:#2f64e1; --green:#22c55e; --red:#ef4444; --ink:#0b1220; --paper:#0f172a; --text:#e5e7eb; }
    body {
      margin:0; background: var(--paper); color:var(--text);
      font: 16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      display:grid; place-items:center; padding:28px;
    }
    .card { width:min(860px,94vw); background:#0c1324; border:1px solid rgba(255,255,255,.08);
            border-radius:16px; padding:22px; box-shadow:0 10px 35px rgba(0,0,0,.35); }
    h1 { margin:0 0 10px; font-size:22px; }
    .note { background:var(--blue); color:#fff; display:inline-block; padding:8px 12px; border-radius:6px; }
    .row { margin:16px 0; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    button {
      padding:12px 18px; border-radius:12px; font-size:16px; border:none; cursor:pointer; color:#fff;
    }
    #callBtn { background:var(--green); }
    #hangBtn { background:var(--red); display:none; }
    #status { margin-top:8px; opacity:.95; }
    #log { margin-top:14px; display:none; background:var(--ink); color:#e5e7eb; padding:12px;
           border-radius:10px; overflow:auto; max-height:40vh; }
  </style>

  <!-- Load the Retell SDK from your repo -->
  <script src="https://impact-agent.github.io/BHI-voice-agent/sdk/retell-sdk.min.js?v=1"></script>
</head>
<body>
  <main class="card">
    <h1>üé§ Talk to our AI Agent</h1>
    <div class="note">Uses your internet (no phone charges). Click ‚ÄúStart Call‚Äù and allow microphone access.</div>

    <div class="row">
      <button id="callBtn">Start Call</button>
      <button id="hangBtn">Hang Up</button>
      <span id="status">Loading agent‚Ä¶</span>
    </div>

    <pre id="log"></pre>
  </main>

  <script>
    // üëâ Your Cloudflare Worker mint URL
    const MINT_URL = "https://frosty-poetry-a7a6.jocelyn-379.workers.dev/";

    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const callBtn = document.getElementById('callBtn');
    const hangBtn = document.getElementById('hangBtn');

    function setStatus(t){ statusEl.textContent = t; }
    function log(msg, obj){
      logEl.style.display='block';
      logEl.textContent += `[${new Date().toISOString()}] ${msg}\n` + (obj ? JSON.stringify(obj, null, 2) + '\n' : '');
      console.log(msg, obj||'');
    }

    // ---- SDK detection ----
    function getRetellCtor() {
      const g = window;
      return (
        g.retellClientJsSdk?.RetellWebClient ||
        g.RetellWebClient ||
        g.retell?.RetellWebClient ||
        g.Retell?.RetellWebClient ||
        null
      );
    }

    function when(conditionFn, timeoutMs = 5000, intervalMs = 50) {
      return new Promise((resolve, reject) => {
        const start = Date.now();
        const t = setInterval(() => {
          if (conditionFn()) { clearInterval(t); resolve(true); }
          else if (Date.now() - start > timeoutMs) { clearInterval(t); reject(new Error("SDK load timeout")); }
        }, intervalMs);
      });
    }

    let client = null;
    let inCall = false;

    async function ensureClient() {
      if (client) return true;
      try {
        await when(() => !!getRetellCtor());
        const Ctor = getRetellCtor();
        if (!Ctor) throw new Error("SDK constructor


