<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Talk to our AI Agent</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --blue:#2f64e1; --green:#22c55e; --red:#ef4444; --ink:#0b1220; --paper:#0f172a; --text:#e5e7eb; }
    html,body { height:100%; }
    body {
      margin:0; background: var(--paper); color:var(--text);
      font: 16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      display:grid; place-items:center; padding:28px;
    }
    .card { width:min(860px,94vw); background:#0c1324; border:1px solid rgba(255,255,255,.08);
            border-radius:16px; padding:22px; box-shadow:0 10px 35px rgba(0,0,0,.35); }
    h1 { margin:0 0 10px; font-size:22px; }
    .note { background:var(--blue); color:#fff; display:inline-block; padding:8px 12px; border-radius:6px; }
    .row { margin:16px 0; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    button {
      padding:12px 18px; border-radius:12px; font-size:16px; border:none; cursor:pointer; color:#fff;
    }
    #callBtn { background:var(--green); }
    #hangBtn { background:var(--red); display:none; }
    #status { margin-top:8px; opacity:.95; }
    #log { margin-top:14px; display:none; background:var(--ink); color:#e5e7eb; padding:12px;
           border-radius:10px; overflow:auto; max-height:40vh; }
    a { color:#9bc1ff; }
  </style>

  <!-- Load the Retell SDK locally (self-hosted) -->
  <script src="./sdk/retell-sdk.min.js"></script>
</head>
<body>
  <main class="card">
    <h1>üé§ Talk to our AI Agent</h1>
    <div class="note">Uses your internet (no phone charges). Click ‚ÄúStart Call‚Äù and allow microphone access.</div>

    <div class="row">
      <button id="callBtn">Start Call</button>
      <button id="hangBtn">Hang Up</button>
      <span id="status">Loading agent‚Ä¶</span>
    </div>

    <pre id="log"></pre>
  </main>

  <script>
    // üëâ Your token-mint endpoint (Cloudflare Worker). Change here only if you rename your Worker URL.
    const MINT_URL = "https://frosty-poetry-a7a6.jocelyn-379.workers.dev/";

    // ---------- UI helpers ----------
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const callBtn = document.getElementById('callBtn');
    const hangBtn = document.getElementById('hangBtn');

    function setStatus(t){ statusEl.textContent = t; }
    function log(msg, obj){
      logEl.style.display='block';
      logEl.textContent += `[${new Date().toISOString()}] ${msg}\n` + (obj ? JSON.stringify(obj, null, 2) + '\n' : '');
      console.log(msg, obj||'');
    }

    // ---------- Retell SDK detection ----------
    function getRetellCtor() {
      const g = window;
      // Try common global export names (covers different bundles)
      return (
        g.retellClientJsSdk?.RetellWebClient ||
        g.RetellWebClient ||
        g.retell?.RetellWebClient ||
        g.Retell?.RetellWebClient ||
        null
      );
    }

    let client = null;
    let inCall = false;

    function ensureClient() {
      if (client) return true;
      const Ctor = getRetellCtor();
      if (!Ctor) { log("SDK not found on window. Did ./sdk/retell-sdk.min.js load?"); return false; }
      try {
        client = new Ctor();
        // Safety: attach listeners if available
        client.on?.("call_ended", endCall);
        client.on?.("error", (e)=>{ console.error("Retell error", e); endCall(); setStatus("Error during call."); });
        return true;
      } catch(e) {
        log("Failed to construct Retell client", { message: e.message });
        return false;
      }
    }

    // ---------- Mint token from Worker ----------
    async function mintToken(){
      // Minimal POST (no headers/body) avoids CORS preflight
      const r = await fetch(MINT_URL, { method:'POST' });
      const text = await r.text();
      try {
        return JSON.parse(text); // { access_token, call_id }
      } catch(e){
        log("Mint endpoint did not return JSON", text);
        throw new Error("Could not get a token. Check Worker and try again.");
      }
    }

    // ---------- Call controls ----------
    async function startCall(){
      try{
        callBtn.disabled = true;
        setStatus("Preparing agent‚Ä¶");
        const ok = ensureClient();
        if (!ok) { setStatus("Agent not ready. Refresh and try again."); return; }

        setStatus("Connecting‚Ä¶ please allow microphone");
        log("POST to mint URL", { url: MINT_URL });
        const { access_token, call_id } = await mintToken();
        log("Got token", { call_id, access_token_preview: (access_token||'').slice(0, 12) + "‚Ä¶" });

        if (!access_token) throw new Error("No access_token returned");
        await client.startCall({ accessToken: access_token });

        inCall = true;
        callBtn.style.display='none'; hangBtn.style.display='inline-block';
        setStatus("Connected. You can speak now.");
      } catch(e){
        setStatus(e.message || "Error starting call. See log.");
        log("startCall error", { message: e.message });
      } finally {
        callBtn.disabled = false;
      }
    }

    function endCall(){
      try{ client?.stopCall?.(); }catch(_){}
      inCall = false;
      hangBtn.style.display='none'; callBtn.style.display='inline-block';
      setStatus("Call ended.");
    }

    // ---------- Wire up buttons ----------
    callBtn.addEventListener('click', ()=>{ if(!inCall) startCall(); });
    hangBtn.addEventListener('click', endCall);

    // ---------- Initial status ----------
    (function init(){
      const ok = ensureClient();
      setStatus(ok ? "Ready." : "Agent not ready ‚Äî check that ./sdk/retell-sdk.min.js exists.");
    })();
  </script>
</body>
</html>

