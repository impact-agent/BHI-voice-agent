<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Talk to our AI Agent</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Stable UMD build of Retell SDK -->
  <script src="https://unpkg.com/retell-client-js-sdk/dist/index.umd.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; text-align:center; margin:40px; }
    button { padding:12px 18px; border-radius:8px; font-size:16px; cursor:pointer; margin:6px; border:none; }
    #callBtn { background:#22c55e; color:white; }
    #hangBtn { background:#ef4444; color:white; display:none; }
    #status { margin-top:12px; font-size:14px; }
    #log { text-align:left; max-width:860px; margin:16px auto; background:#0b1220; color:#e5e7eb; padding:12px; border-radius:8px; overflow:auto; display:none; }
  </style>
</head>
<body>
  <h1>üé§ Talk to our AI Agent</h1>
  <p>Uses your internet (no phone charges). Click ‚ÄúStart Call‚Äù and allow microphone access.</p>

  <button id="callBtn">Start Call</button>
  <button id="hangBtn">Hang Up</button>
  <div id="status">Ready.</div>
  <pre id="log"></pre>

  <script>
    // üëâ Paste your Zapier Catch Hook URL here:
    const MINT_URL = "https://hooks.zapier.com/hooks/catch/23863897/uh3c1gn/";

    // Helper: visible debug
    const logEl = document.getElementById('log');
    function log(msg, obj) {
      logEl.style.display = 'block';
      logEl.textContent += `[${new Date().toISOString()}] ${msg}\n` + (obj ? JSON.stringify(obj, null, 2) + '\n' : '');
      console.log(msg, obj || '');
    }
    function setStatus(t){ document.getElementById('status').textContent = t; }

    // Get the SDK constructor safely
    function getRetellCtor() {
      const g = window;
      return g.RetellWebClient || (g.retellClientJsSdk && g.retellClientJsSdk.RetellWebClient) || null;
    }
    const RetellCtor = getRetellCtor();
    const client = RetellCtor ? new RetellCtor() : null;

    const callBtn = document.getElementById('callBtn');
    const hangBtn = document.getElementById('hangBtn');
    let inCall = false;

    async function mintToken() {
      // Preflight-free POST (no headers/body) to avoid browser blocks
      const r = await fetch(MINT_URL, { method: 'POST' });
      const text = await r.text();
      try {
        const json = JSON.parse(text);
        return json; // { access_token, call_id }
      } catch (e) {
        log("Zap did not return JSON (likely Step 3 not returning data). Raw:", text);
        throw new Error("Could not get a token. Please try again.");
      }
    }

    async function startCall(){
      try {
        if (!client) { setStatus("Agent not ready‚Äîrefresh the page."); return; }
        callBtn.disabled = true;
        setStatus("Connecting‚Ä¶ please allow microphone access");
        log("POSTing to Zap", { url: MINT_URL });

        const { access_token, call_id } = await mintToken();
        log("Got token", { call_id, access_token_preview: (access_token || '').slice(0, 8) + "‚Ä¶" });

        if (!access_token) throw new Error("No access_token returned");
        await client.startCall({ accessToken: access_token });

        inCall = true;
        callBtn.style.display = "none";
        hangBtn.style.display = "inline-block";
        setStatus("Connected. You can speak now.");
      } catch (e) {
        console.error(e);
        setStatus(e.message || "Error starting call.");
      } finally {
        callBtn.disabled = false;
      }
    }

    function endCall(){
      try { client && client.stopCall && client.stopCall(); } catch(_){}
      inCall = false;
      hangBtn.style.display = "none";
      callBtn.style.display = "inline-block";
      setStatus("Call ended.");
    }

    callBtn.addEventListener('click', () => { if (!inCall) startCall(); });
    hangBtn.addEventListener('click', endCall);

    client && client.on && client.on("call_ended", endCall);
    client && client.on && client.on("error", (e) => { console.error("Retell error", e); endCall(); setStatus("Error during call."); });
  </script>
</body>
</html>
