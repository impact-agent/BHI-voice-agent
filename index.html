<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Talk to our AI Agent</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --blue:#2f64e1; --green:#22c55e; --red:#ef4444; --ink:#0b1220; --paper:#0f172a; --text:#e5e7eb; }
    body { margin:0; background:var(--paper); color:var(--text);
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      display:grid; place-items:center; padding:28px; }
    .card { width:min(860px,94vw); background:#0c1324; border:1px solid rgba(255,255,255,.08);
            border-radius:16px; padding:22px; box-shadow:0 10px 35px rgba(0,0,0,.35); }
    h1 { margin:0 0 10px; font-size:22px; }
    .note { background:var(--blue); color:#fff; display:inline-block; padding:8px 12px; border-radius:6px; }
    .row { margin:16px 0; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    button { padding:12px 18px; border-radius:12px; font-size:16px; border:none; cursor:pointer; color:#fff; }
    #callBtn { background:var(--green); }
    #hangBtn { background:var(--red); display:none; }
    #status { margin-top:8px; opacity:.95; }
    #log { margin-top:14px; display:none; background:var(--ink); color:#e5e7eb; padding:12px;
           border-radius:10px; overflow:auto; max-height:40vh; }
    .pill { font-size:12px; background:#1b2a55; border:1px solid #274080;
            border-radius:999px; padding:4px 8px; margin-left:8px }
  </style>

  <!-- Load SDK from CDN (browser build, not Node) with fallback -->
  <script>
    function loadScript(src){
      return new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src=src; s.onload=res; s.onerror=rej;
        document.head.appendChild(s);
      });
    }
    async function ensureSdkLoaded(){
      try {
        await loadScript("https://cdn.jsdelivr.net/npm/retell-client-js-sdk@2.0.7/dist/index.min.js");
      } catch {
        await loadScript("https://unpkg.com/retell-client-js-sdk@2.0.7/dist/index.min.js");
      }
    }
  </script>
</head>
<body>
  <main class="card">
    <h1>üé§ Talk to our AI Agent <span id="sdkSource" class="pill" style="display:none"></span></h1>
    <div class="note">Uses your internet (no phone charges). Click ‚ÄúStart Call‚Äù and allow microphone access.</div>

    <div class="row">
      <button id="callBtn">Start Call</button>
      <button id="hangBtn">Hang Up</button>
      <span id="status">Loading agent‚Ä¶</span>
    </div>

    <pre id="log"></pre>
  </main>

  <script>
    // üëâ Your Cloudflare Worker mint URL
    const MINT_URL = "https://frosty-poetry-a7a6.jocelyn-379.workers.dev/";

    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const callBtn = document.getElementById('callBtn');
    const hangBtn = document.getElementById('hangBtn');
    const sdkSource = document.getElementById('sdkSource');

    function setStatus(t){ statusEl.textContent = t; }
    function log(msg, obj){
      logEl.style.display='block';
      logEl.textContent += `[${new Date().toISOString()}] ${msg}\n` +
        (obj ? JSON.stringify(obj, null, 2) + '\n' : '');
      console.log(msg, obj||'');
    }

    // ---- SDK constructor probe ----
    function getCtorName(g){
      if (g.retellClientJsSdk?.RetellWebClient) return "window.retellClientJsSdk.RetellWebClient";
      if (g.RetellWebClient) return "window.RetellWebClient";
      return null;
    }
    function getCtor(g){
      return g.retellClientJsSdk?.RetellWebClient || g.RetellWebClient || null;
    }
    function waitFor(cond, timeout=6000, every=50){
      return new Promise((resolve,reject)=>{
        const t0=Date.now(); const id=setInterval(()=>{
          if(cond()){clearInterval(id); resolve(true);}
          else if(Date.now()-t0>timeout){clearInterval(id); reject(new Error("timeout")); }
        }, every);
      });
    }

    let client=null, inCall=false;

    async function ensureClient(){
      if (client) return true;
      await ensureSdkLoaded();
      try { await waitFor(()=>!!getCtorName(window)); } catch(e){ }
      const name = getCtorName(window);
      if (!name) {
        log("SDK not found on window after waiting.");
        setStatus("Agent not ready ‚Äî refresh and try again.");
        return false;
      }
      sdkSource.style.display='inline-block';
      sdkSource.textContent = `SDK: ${name.replace("window.","")}`;
      try {
        const Ctor = getCtor(window);
        client = new Ctor();
        client.on?.("call_ended", endCall);
        client.on?.("error", (e)=>{ console.error("Retell error", e); endCall(); setStatus("Error during call."); });
        return true;
      } catch(e) {
        log("Failed to construct client", { message:e.message });
        setStatus("Could not init agent.");
        return false;
      }
    }

    // ---- Mint token from Worker ----
    async function mintToken(){
      const r = await fetch(MINT_URL, { method:'POST' });
      const text = await r.text();
      try { return JSON.parse(text); }
      catch(e){ log("Mint endpoint did not return JSON", text);
        throw new Error("Could not get a token. Check Worker."); }
    }

    // ---- Call controls ----
    async function startCall(){
      try {
        callBtn.disabled = true;
        setStatus("Preparing agent‚Ä¶");
        const ok = await ensureClient();
        if (!ok) return;

        setStatus("Connecting‚Ä¶ please allow microphone");
        log("POST to mint URL", { url: MINT_URL });
        const { access_token, call_id } = await mintToken();
        log("Got token", { call_id, access_token_preview:(access_token||'').slice(0,12)+"‚Ä¶" });

        await client.startCall({ accessToken: access_token });
        inCall = true;
        callBtn.style.display='none'; hangBtn.style.display='inline-block';
        setStatus("Connected. You can speak now.");
      } catch(e) {
        setStatus(e.message || "Error starting call. See log.");
        log("startCall error", { message:e.message });
      } finally {
        callBtn.disabled = false;
      }
    }
    function endCall(){
      try{ client?.stopCall?.(); }catch(_){}
      inCall=false;
      hangBtn.style.display='none'; callBtn.style.display='inline-block';
      setStatus("Call ended.");
    }

    callBtn.addEventListener('click', ()=>{ if(!inCall) startCall(); });
    hangBtn.addEventListener('click', endCall);

    // ---- Initial probe ----
    (async () => {
      const ok = await ensureClient();
      setStatus(ok ? "Ready." : "Agent not ready ‚Äî please refresh.");
    })();
  </script>
</body>
</html>
